<!Doctype html>
<html>

<head>
    <title>Direction Field Example</title>
    <script src="bundle.js"></script>

    <style>
        .parent {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap-reverse;
        }
    </style>
</head>

<body>
    <div class="parent">
        <div id="container" style="width: 400px; height: 400px"></div>
        <div id="controls">
            <div>F'(x,y)=<input id="FPrime" type="text" value="Math.sin(x) + y"/></div>
            <div><button onClick="handleGraphButtonClick()">Graph it!</button></div>
        </div>
    </div>
</body>

<script>
    function getFPrime() {
        var fprimeStr = document.getElementById("FPrime").value;
        var functionStr = "(pt) => { let x = pt[0], y = pt[1]; return (" + fprimeStr + "); }";
        return eval(functionStr);
    }
    var fPrime = getFPrime();

    var viz = new Viz(document.getElementById("container"), 400, 400);
    viz.shouldDrawAxes = true;

    var la;
    viz.setOnMousemove(function(pt) {
        if (la != null) {
            viz.removeShape(la);
        }

        la = new LinearApproximation()
            .withColor("red")
            .withPoint(pt)
            .withFPrime(fPrime);
        viz.addShape(la);
        viz.refresh();
    });
    viz.setOnMouseleave(function() {
        if (la != null) {
            viz.removeShape(la);
            viz.refresh();
        }
    });
    
    function handleGraphButtonClick() {
        viz.reset();

        fPrime = getFPrime();

        for (let x = Math.floor(viz.minX); x < viz.maxX; x++) {
            for(let y = Math.floor(viz.minY); y < viz.maxY; y++) {
                var slope = fPrime([x,y])
                
                // Don't graph when the derivative is not defined 
                if (isFinite(slope)) {
                    let ls = new LineSegment()
                        .withCenter([x,y])
                        .withSlope(slope)
                        .withLength(1);
                    viz.addShape(ls);
                }
            }
        }

        viz.refresh();
    }

    // initialize
    handleGraphButtonClick();

    // var FPrime = (x, y) => x + y
    // var FPrime = (x, y) => 2 * (y - 1) / x
    // var FPrime = (x, y) => 2 * x; 
    // var FPrime = (x, y) => 2 * y / x; 
    // var FPrime = (x, y) => (x - y) / (x + y);
    // Math.sin(x * y)

    // TODO
    // Showing integral curve
    // Showing isoclines?
    // Calculating singular points
    // Show integral curve when hovering over
    //   - How accurate can this be? How quickly can the approximation diverge from the true value?
    //          - Arbitrarily quickly. True value could approach exact opposite direction of approximation), although this
    //            this behavior will be limited by the number of non-zero derivatives (could we generate a function that
    //            "runs away" from its linear approximation?
    //   - What do we use to measure the "flatness" of a function?
    //          - In some sense, the number of non-zero derivatives will be a good measure
    //   - We can improve this approximation using Taylor series in the future, but this will probably require
    //     developing a symbolic computation system to compute derivatives.
</script>

</html>